# Copyright 2000, International Business Machines Corporation and others.
# All Rights Reserved.
# 
# This software has been released under the terms of the IBM Public
# License.  For details, see the LICENSE file in the top-level source
# directory or online at http://www.openafs.org/dl/license10.html

srcdir=@srcdir@
include @TOP_OBJDIR@/src/config/Makefile.config
include @TOP_OBJDIR@/src/config/Makefile.pthread

INCLS=${TOP_INCDIR}/afs/afsint.h \
	${TOP_INCDIR}/afs/cmd.h \
	${TOP_INCDIR}/afs/afsutil.h

AFSIO_INCLS=${TOP_INCDIR}/afs/afsint.h \
	${TOP_INCDIR}/afs/cmd.h \
	${TOP_INCDIR}/afs/auth.h \
	${TOP_INCDIR}/afs/vlserver.h \
	${TOP_INCDIR}/afs/ihandle.h \
	${TOP_INCDIR}/afs/com_err.h \
	${TOP_INCDIR}/afs/afscp.h \
	${TOP_INCDIR}/afs/afsutil.h

AFSIO_LIBS = \
	$(top_builddir)/src/libafscp/liboafs_afscp.la \
	$(top_builddir)/src/rxkad/liboafs_rxkad.la \
	$(top_builddir)/src/fsint/liboafs_fsint.la \
	$(top_builddir)/src/vlserver/liboafs_vldb.la \
	$(top_builddir)/src/cmd/liboafs_cmd.la \
	$(top_builddir)/src/util/liboafs_util.la \
	$(top_builddir)/src/opr/liboafs_opr.la

FSLIBS= \
	$(top_builddir)/src/sys/liboafs_sys.la \
	$(top_builddir)/src/vlserver/liboafs_vldb.la \
	$(top_builddir)/src/ubik/liboafs_ubik.la \
	$(top_builddir)/src/auth/liboafs_auth.la \
	$(top_builddir)/src/rxkad/liboafs_rxkad.la \
	$(top_builddir)/src/comerr/liboafs_comerr.la \
	$(top_builddir)/src/cmd/liboafs_cmd.la \
	$(top_builddir)/src/kauth/liboafs_kauth.la \
	$(top_builddir)/src/rx/liboafs_rx.la \
	$(top_builddir)/src/audit/liboafs_audit.la \
	$(top_builddir)/src/util/liboafs_util.la \
	$(top_builddir)/src/opr/liboafs_opr.la \
	$(top_builddir)/src/crypto/rfc3961/liboafs_rfc3961.la \
	$(top_builddir)/src/crypto/hcrypto/libafshcrypto.la

CMLIBS= \
	$(top_builddir)/src/sys/liboafs_sys.la \
	$(top_builddir)/src/fsint/liboafs_fsint.la \
	$(top_builddir)/src/rxkad/liboafs_rxkad.la \
	$(top_builddir)/src/auth/liboafs_auth.la \
	$(top_builddir)/src/comerr/liboafs_comerr.la \
	$(top_builddir)/src/cmd/liboafs_cmd.la \
	$(top_builddir)/src/rx/liboafs_rx.la \
	$(top_builddir)/src/crypto/hcrypto/libafshcrypto.la \
	$(top_builddir)/src/opr/liboafs_opr.la \
	$(top_builddir)/src/util/liboafs_util.la

LIBS = ${FSLIBS}

all: fs up fstrace cmdebug livesys cacheout afsio

#
# Build targets
#
cacheout: cacheout.o
	$(LT_LDRULE_static) cacheout.o ${LIBS} $(LIB_roken) ${XLIBS} ${CMLIBS}

cacheout.o: cacheout.c


up.o: up.c AFS_component_version_number.c

up: up.o
	$(LT_LDRULE_static) up.o ${LIBS} $(LIB_roken) ${XLIBS}

fs.o: fs.c ${INCLS} AFS_component_version_number.c

fs: fs.o $(LIBS)
	$(LT_LDRULE_static) fs.o ${TOP_LIBDIR}/libprot.a $(LIBS) \
		$(LIB_roken) ${XLIBS}

afsio.o: afsio.c ${AFSIO_INCLS} AFS_component_version_number.c
	${PTH_CCRULE} ${srcdir}/afsio.c
afscbint.ss.o: ../fsint/afscbint.ss.c
	${PTH_CCRULE} ../fsint/afscbint.ss.c

afsio: afsio.o afscbint.ss.o ${AFSIO_LIBS}
	$(LT_LDRULE_static) afsio.o afscbint.ss.o \
		${AFSIO_LIBS} \
		$(LIB_hcrypto) $(LIB_roken) ${MT_LIBS} \
		$(LDFLAGS_krb5) $(LIB_krb5)

livesys.o: livesys.c ${INCLS} AFS_component_version_number.c

livesys: livesys.o $(LIBS)
	$(LT_LDRULE_static) livesys.o $(LIBS) $(LIB_roken) ${XLIBS}

twiddle: twiddle.o $(LIBS)
	$(LT_LDRULE_static) twiddle.o $(LIBS) $(LIB_roken) ${XLIBS}

gcpags: gcpags.o $(LIBS)
	$(LT_LDRULE_static) gcpags.o $(LIBS) $(LIB_roken) ${XLIBS}

whatfid.o: whatfid.c ${INCLS} AFS_component_version_number.c

whatfid: whatfid.o ${LIBS}
	$(LT_LDRULE_static) whatfid.o ${LIBS} $(LIB_roken) ${XLIBS}

fstrace: fstrace.o
	$(LT_LDRULE_static) fstrace.o $(LIBS) $(LIB_roken) ${XLIBS}

cmdebug.o: cmdebug.c ${INCLS} AFS_component_version_number.c

cmdebug: cmdebug.o ${CMLIBS}
	$(LT_LDRULE_static) cmdebug.o ${CMLIBS} $(LIB_roken) ${XLIBS}

dedebug.o: dedebug.c ${INCLS} AFS_component_version_number.c

dedebug: dedebug.o ${CMLIBS}
	$(LT_LDRULE_static) dedebug.o ${CMLIBS} $(LIB_roken) ${XLIBS}

#
# Install targets
#
install: fs livesys up fstrace cmdebug afsio
	${INSTALL} -d ${DESTDIR}${bindir}
	${INSTALL} -d ${DESTDIR}${afssrvbindir}
	${INSTALL} -d ${DESTDIR}${sbindir}
	${INSTALL_PROGRAM} fs ${DESTDIR}${bindir}/fs
	${INSTALL_PROGRAM} livesys ${DESTDIR}${bindir}/livesys
	${INSTALL_PROGRAM} fs ${DESTDIR}${afssrvbindir}/fs
	${INSTALL_PROGRAM} up ${DESTDIR}${bindir}/up
	${INSTALL_PROGRAM} fstrace ${DESTDIR}${sbindir}/fstrace
	${INSTALL_PROGRAM} cmdebug ${DESTDIR}${bindir}/cmdebug
	${INSTALL_PROGRAM} afsio ${DESTDIR}${bindir}/afsio ;

dest: fs livesys up fstrace cmdebug afsio
	${INSTALL} -d ${DEST}/bin
	${INSTALL} -d ${DEST}/etc
	${INSTALL} -d ${DEST}/root.server/usr/afs/bin
	${INSTALL_PROGRAM} fs ${DEST}/bin/fs
	${INSTALL_PROGRAM} livesys ${DEST}/bin/livesys
	${INSTALL_PROGRAM} fs ${DEST}/root.server/usr/afs/bin/fs
	${INSTALL_PROGRAM} up ${DEST}/bin/up
	${INSTALL_PROGRAM} fstrace ${DEST}/etc/fstrace
	${INSTALL_PROGRAM} cmdebug ${DEST}/bin/cmdebug
	${INSTALL_PROGRAM} afsio ${DEST}/bin/afsio

#
# Misc targets
#

clean:
	$(LT_CLEAN)
	$(RM) -f *.o *.a up fs core cmdebug \
		AFS_component_version_number.c fstrace gcpags livesys dedebug \
		cacheout afsio

.PHONY: test
test:
	cd test && $(MAKE)

include ../config/Makefile.version
